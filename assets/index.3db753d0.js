import{F as re,u as oe}from"./provide.719f686d.js";import{I as ne}from"./index.9d72b942.js";import{P as se}from"./index.6b77ffa4.js";import{I as ie}from"./index.05bed42d.js";import{R as de}from"./index.931337ba.js";import{q as ue,r as W,b as ce,y as ve,p as S,d as $,e as me,o as m,c as p,a as w,F as pe,j as fe,i as q,m as j,t as ge,J as ye,h as _,f as R,n as he,B as be,w as Ve,z as we}from"./vendor.ea41cd30.js";import{m as J,n as G,i as _e,c as K,t as O,o as Re}from"./shared.af52c411.js";import{u as Pe}from"./components.654cdc86.js";import{_ as Ce}from"./elevation.7f6c0241.js";const Fe={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},onBeforeRead:{type:Function},onAfterRead:{type:Function},onOversize:{type:Function},onRemove:{type:Function},"onUpdate:modelValue":{type:Function}};let Be=0;const ke=ue({name:"VarUploader",directives:{Ripple:de},components:{VarIcon:ne,VarPopup:se,VarFormDetails:re},props:Fe,setup(e){const u=W(!1),P=W(null),U=ce(()=>{const{maxlength:a,modelValue:{length:r}}=e;return _e(a)?`${r} / ${a}`:""}),{form:l,bindForm:y}=oe(),{errorMessage:h,validateWithTrigger:C,validate:F,resetValidation:f}=Pe(),t=a=>{const{disabled:r,readonly:o,previewed:s}=e;if((l==null?void 0:l.disabled.value)||(l==null?void 0:l.readonly.value)||r||o||!s)return;const{url:n}=a;if(K(n)&&G(n)){ie(n);return}K(n)&&J(n)&&(P.value=a,u.value=!0)},g=a=>({id:Be++,url:"",cover:"",name:a.name,file:a}),Q=a=>{const r=a.target,{files:o}=r;return Array.from(o)},X=a=>new Promise(r=>{const o=new FileReader;o.onload=()=>{const s=o.result;a.file.type.startsWith("image")&&(a.cover=s),a.url=s,r(a)},o.readAsDataURL(a.file)}),Y=a=>a.map(X),Z=a=>{const{onBeforeRead:r}=e;return a.map(o=>new Promise(s=>{const n=r?r(S(o)):!0;Promise.resolve(n).then(c=>s({valid:c,varFile:o}))}))},x=async a=>{var H;const{maxsize:r,maxlength:o,modelValue:s,onOversize:n,onAfterRead:c,readonly:b,disabled:i}=e;if((l==null?void 0:l.disabled.value)||(l==null?void 0:l.readonly.value)||i||b)return;const k=d=>d.filter(V=>V.file.size>O(r)?(n==null||n(S(V)),!1):!0),le=d=>{const V=Math.min(d.length,O(o)-s.length);return d.slice(0,V)};let v=Q(a).map(g);v=r!=null?k(v):v,v=o!=null?le(v):v;const te=await Promise.all(Y(v)),E=(await Promise.all(Z(te))).filter(({valid:d})=>d).map(({varFile:d})=>d);(H=e["onUpdate:modelValue"])==null||H.call(e,[...s,...E]),a.target.value="",E.forEach(d=>c==null?void 0:c(S(d)))},ee=a=>{const{disabled:r,readonly:o,modelValue:s,onRemove:n}=e;if((l==null?void 0:l.disabled.value)||(l==null?void 0:l.readonly.value)||r||o)return;const c=s.filter(i=>i!==a),b=()=>{var i;(i=e["onUpdate:modelValue"])==null||i.call(e,c),N("onRemove")};if(n){const i=n(a);if(Re(i)){i.then(k=>{k||b()});return}if(i)return}b()},T=()=>e.modelValue.filter(a=>a.state==="success"),L=()=>e.modelValue.filter(a=>a.state==="error"),z=()=>e.modelValue.filter(a=>a.state==="loading"),M={getSuccess:T,getError:L,getLoading:z},N=a=>{we(()=>{const{validateTrigger:r,rules:o,modelValue:s}=e;C(r,a,o,s,M)})};let B=!1;const I=()=>F(e.rules,e.modelValue,M),A=()=>{var a;B=!0,(a=e["onUpdate:modelValue"])==null||a.call(e,[]),f()},ae={validate:I,resetValidation:f,reset:A};return y==null||y(ae),ve(()=>e.modelValue,()=>{!B&&N("onChange"),B=!1},{deep:!0}),{showPreview:u,currentPreview:P,errorMessage:h,maxlengthText:U,isHTMLSupportVideo:J,isHTMLSupportImage:G,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,preview:t,handleChange:x,handleRemove:ee,getSuccess:T,getError:L,getLoading:z,validate:I,resetValidation:f,reset:A}}}),Se={class:"var-uploader var--box"},$e={class:"var-uploader__file-list"},je=["onClick"],De={class:"var-uploader__file-name"},Ue=["onClick"],Te=["src","alt"],Le=["multiple","accept","capture","disabled"],ze=["src"];function Me(e,u,P,U,l,y){const h=$("var-icon"),C=$("var-form-details"),F=$("var-popup"),f=me("ripple");return m(),p("div",Se,[w("div",$e,[(m(!0),p(pe,null,fe(e.modelValue,t=>q((m(),p("div",{class:j(["var-uploader__file var-elevation--2",[t.state==="loading"?"var-uploader--loading":null]]),key:t.id,onClick:g=>e.preview(t)},[w("div",De,ge(t.name||t.url),1),e.removable?(m(),p("div",{key:0,class:"var-uploader__file-close",onClick:ye(g=>e.handleRemove(t),["stop"])},[_(h,{class:"var-uploader__file-close-icon","var-uploader-cover":"",name:"delete"})],8,Ue)):R("v-if",!0),t.cover?(m(),p("img",{key:1,class:"var-uploader__file-cover",style:he({objectFit:t.fit}),src:t.cover,alt:t.name},null,12,Te)):R("v-if",!0),w("div",{class:j(["var-uploader__file-indicator",[t.state==="success"?"var-uploader--success":null,t.state==="error"?"var-uploader--error":null]])},null,2)],10,je)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?q((m(),p("div",{key:0,class:j(["var--relative",[e.$slots.default?null:"var-uploader__action var-elevation--2",e.disabled||e.formDisabled?"var-uploader--disabled":null]])},[w("input",{class:"var-uploader__action-input",type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:u[0]||(u[0]=(...t)=>e.handleChange&&e.handleChange(...t))},null,40,Le),be(e.$slots,"default",{},()=>[_(h,{class:"var-uploader__action-icon","var-uploader-cover":"",name:"plus"})])],2)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):R("v-if",!0)]),_(C,{"error-message":e.errorMessage,"maxlength-text":e.maxlengthText},null,8,["error-message","maxlength-text"]),_(F,{class:"var-uploader__preview","var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":u[1]||(u[1]=t=>e.showPreview=t),onClosed:u[2]||(u[2]=t=>e.currentPreview=null)},{default:Ve(()=>{var t,g;return[e.currentPreview&&e.isHTMLSupportVideo((t=e.currentPreview)==null?void 0:t.url)?(m(),p("video",{key:0,class:"var-uploader__preview-video",playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(g=e.currentPreview)==null?void 0:g.url},null,8,ze)):R("v-if",!0)]}),_:1},8,["show"])])}var D=Ce(ke,[["render",Me]]);D.install=function(e){e.component(D.name,D)};export{D as U};
